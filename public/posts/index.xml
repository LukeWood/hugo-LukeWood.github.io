<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title>Posts on Luke Wood</title>
		<link>https://LukeWood.dev/posts/</link>
		<description>Recent content in Posts on Luke Wood</description>
		<generator>Hugo -- gohugo.io</generator>
		<language>en-us</language>
		<copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright>
		<lastBuildDate>Thu, 11 Jul 2019 20:13:20 -0700</lastBuildDate>
		<atom:link href="https://LukeWood.dev/posts/index.xml" rel="self" type="application/rss+xml" />
		
		<item>
			<title>Decouple Your Javascript Using Event Driven Programming Tiny-Pubsub</title>
			<link>https://LukeWood.dev/posts/refactor_bulletz/</link>
			<pubDate>Thu, 11 Jul 2019 20:13:20 -0700</pubDate>
			
			<guid>https://LukeWood.dev/posts/refactor_bulletz/</guid>
			<description>I am the sole author of the web game bulletz.io. Recently I refactored the frontend&amp;rsquo;s codebase to more closely match that of the backend. The backend is written using the functional programming language Elixir while the frontend is written in Vanilla Javascript. Both programming languages are vastly different.
Originally the frontend was written using a generic OOP model. This led to a great deal of technical debt, complicated UI interactions, and overall confusing code.</description>
			<content type="html"><![CDATA[

<p>I am the sole author of the web game <a href="https://bulletz.io">bulletz.io</a>.
Recently I refactored the frontend&rsquo;s codebase to more closely match that of the backend.
The backend is written using the functional programming language <a href="https://elixir-lang.org">Elixir</a> while the frontend is written in Vanilla Javascript.
Both programming languages are <strong><em>vastly</em></strong> different.</p>

<p>Originally the frontend was written using a generic OOP model.
This led to a great deal of technical debt, complicated UI interactions, and overall confusing code.
I rewrote the frontend over the course of a single evening to use an event driven model to more closely match the backends logic.</p>

<figure class="bordered-figure">
    <img src="/img/posts/bulletz/bulletz.png"
         alt="screenshot of bulletz.io being played" width="512px"/> <figcaption>
            <h4>A screenshot of bulletz.io</h4>
        </figcaption>
</figure>


<p>Over time a <a href="https://en.wikipedia.org/wiki/God_object">god object</a> emerged which led my frontend client to have all sorts of anti patterns littered everywhere.
This article will describe how my mega class emerged and how I ended up solving that problem.</p>

<h1 id="the-original-model">The Original Model</h1>

<p>The original state management model for the bullets took an object oriented model.
A central <strong><em>StateManager</em></strong> class managed the entirety of the game&rsquo;s state by delegating each entity it&rsquo;s own Sub-Manager.</p>

<p>These managers attempted to guess the current state of entities based on the last update on the entity that they received from the server.
This allows the game to run using very low amounts of bandwidth while still showing the real time state of each entity.</p>

<figure class="bordered-figure dark-gray-background">
    <img src="/img/posts/bulletz/bulletz_old_frontend.png"
         alt="screenshot of bulletz.io being played" width="512px"/> <figcaption>
            <h4>State Manager Delegation System</h4>
        </figcaption>
</figure>


<p>This led to a ton of problems over time - primarily on the front of readability and maintainability.
The state of the various entities became inter-twined over time and it became difficult to hunt down bugs due to this.</p>

<p>The largest anti-pattern the old model used was having a <a href="https://en.wikipedia.org/wiki/God_object">god object</a>, the top level State Manager.</p>

<p>This state manager ended up being responsible for all sorts of things and was passed as a parameter to tons of UI functions.</p>

<p>Here is the file that handles displaying the number players:
<code>player_counter.js</code></p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">const</span> <span class="nx">player_count</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;score-div&#34;</span><span class="p">);</span>
<span class="kd">function</span> <span class="nx">update_player_counter</span><span class="p">(</span><span class="nx">state_handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">score</span> <span class="o">=</span> <span class="nx">state_handler</span><span class="p">.</span><span class="nx">player_registry</span><span class="p">.</span><span class="nx">get_players</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
  <span class="nx">player_count</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">players</span><span class="si">}</span><span class="sb">/20`</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">export</span> <span class="p">{</span><span class="nx">update_player_counter</span><span class="p">}</span>
</code></pre></div>
<p>Then the function <code>update_player_counter</code> has to be called elsewhere every time a new player spawns or dies&hellip;
Throughout the code base there are three occurrences of this function being called.
<code>player_registry.js</code></p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">import</span> <span class="p">{</span><span class="nx">update_player_counter</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;../../ui/update_player_counter&#39;</span>
<span class="k">class</span> <span class="nx">PlayerRegistry</span> <span class="p">{</span>
  <span class="nx">constructor</span><span class="p">(</span><span class="nx">state_handler</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state_handler</span> <span class="o">=</span> <span class="nx">state_handler</span>
  <span class="p">}</span>
  <span class="p">...</span>
  <span class="nx">add_player</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="nx">update_player_counter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state_handler</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="p">...</span>
  <span class="nx">remove_player</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="nx">update_player_counter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state_handler</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>state_handler.js</code></p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">import</span> <span class="p">{</span><span class="nx">update_player_counter</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;../../ui/update_player_counter&#39;</span>
<span class="k">class</span> <span class="nx">StateHandler</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="nx">listen_for_polls</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">update_socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;poll&#34;</span><span class="p">,</span> <span class="p">(</span><span class="nx">game_state</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="p">...</span>
      <span class="nx">update_player_counter</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">})</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<p>This is not that big of a deal for this one specific case, but it resulted in the state handling code being littered with code updating UI.
Other classes end up being responsible for triggering UI updates.</p>

<p>The state_handler ended up being responsible for triggering UI updates, and was an argument to literally everything.
Almost every method, ui interaction, etc needed to store a copy of a state handler.
This mean&rsquo;t every time I registered an event listener I would need a state handler handily stored nearby.
By the time I had a complete frontend the name <code>state_handler</code> showed up in well over <code>70%</code> of files.</p>

<h1 id="solving-this-with-tiny-pubsub">Solving This With Tiny Pubsub</h1>

<p>Shameless plug for the self authored javascript library I wrote to solve this: <a href="https://github.com/LukeWood/tiny-pubsub">tiny-pubsub</a>.
It&rsquo;s nothing special - it just maintains a relationship between events and functions that should be called in response to said events.
Instead of explicitly calling functions, functions instead respond to data emitted elsewhere.</p>

<p>But what it does do is encourage a <a href="https://gameprogrammingpatterns.com/decoupling-patterns.html">decoupled codebase</a> through the event driven programming paradigm..</p>

<p>Here is a self contained example:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">import</span> <span class="p">{</span><span class="nx">subscribe</span><span class="p">,</span> <span class="nx">publish</span><span class="p">,</span> <span class="nx">unsubscribe</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;tiny-pubsub&#39;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">CHATROOM_JOIN</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;./event_definitions&#39;</span>
<span class="kd">let</span> <span class="nx">logJoin</span> <span class="o">=</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb"> has joined the room!`</span><span class="p">);</span>
<span class="nx">subscribe</span><span class="p">(</span><span class="nx">CHATROOM_JOIN</span><span class="p">,</span> <span class="nx">logJoin</span><span class="p">)</span>
<span class="nx">publish</span><span class="p">(</span><span class="nx">CHATROOM_JOIN</span><span class="p">,</span> <span class="s2">&#34;Luke&#34;</span><span class="p">)</span>
<span class="c1">// &gt; Luke has joined the room!
</span><span class="c1"></span><span class="nx">unsubscribe</span><span class="p">(</span><span class="nx">CHATROOM_JOIN</span><span class="p">,</span> <span class="nx">logJoin</span><span class="p">)</span>
<span class="nx">publish</span><span class="p">(</span><span class="nx">CHATROOM_JOIN</span><span class="p">,</span> <span class="s2">&#34;Luke&#34;</span><span class="p">)</span>
<span class="c1">// nothing will print
</span><span class="c1"></span>
<span class="c1">// alternatively you can use strings as event identifiers
</span><span class="c1"></span><span class="nx">subscribe</span><span class="p">(</span><span class="s2">&#34;chatroom-join&#34;</span><span class="p">,</span> <span class="nx">logJoin</span><span class="p">)</span>
<span class="nx">publish</span><span class="p">(</span><span class="s2">&#34;chatroom-join&#34;</span><span class="p">,</span> <span class="s2">&#34;Luke&#34;</span><span class="p">)</span>
<span class="c1">// &gt; Luke has joined the room!
</span></code></pre></div>
<h1 id="refactoring-the-old-model">Refactoring The Old Model</h1>

<p>The refactored model is significantly more distributed in terms of code organization.
In the new model each entity has a series of callbacks described in a single file that specify the entirety of that entities state management.
These events are fired from other self contained modules that are solely responsible for firing these events.</p>

<p>For example, the file <code>tick.js</code> looks something like this&hellip;</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">import</span> <span class="p">{</span><span class="nx">TICK</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;../events&#39;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">game_time</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;../util/game_time&#39;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">get_world</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;../entities/world&#39;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">render</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;../graphics/render&#39;</span>

<span class="kd">function</span> <span class="nx">game_loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">publish</span><span class="p">(</span><span class="nx">TICK</span><span class="p">,</span> <span class="nx">game_time</span><span class="p">(),</span> <span class="nx">get_world</span><span class="p">());</span>
  <span class="nx">render</span><span class="p">();</span>
  <span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">game_loop</span><span class="p">)</span>
<span class="p">}</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;load&#34;</span><span class="p">,</span> <span class="nx">game_loop</span><span class="p">);</span>
</code></pre></div>
<p>Each file is responsible for only one type of event.
Some events are triggered by other events and mutate the data a bit for use by other modules.</p>

<p>For example, here is the new version of <code>score.js</code> looks like&hellip;</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">import</span> <span class="p">{</span><span class="nx">subscribe</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;tiny-pubsub&#39;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">PLAYER</span><span class="p">,</span> <span class="nx">POLL</span><span class="p">,</span> <span class="nx">PLAYER_DEATH</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;../events&#39;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">get_players</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;../entities/players&#39;</span>
<span class="k">const</span> <span class="nx">player_count</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;score-div&#34;</span><span class="p">);</span>
<span class="k">const</span> <span class="nx">update_player_count</span> <span class="o">=</span>  <span class="p">({</span><span class="nx">players</span><span class="o">:</span> <span class="nx">players</span><span class="p">})</span> <span class="p">=&gt;</span> <span class="nx">player_count</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">get_players</span><span class="p">().</span><span class="nx">length</span><span class="si">}</span><span class="sb">/20`</span><span class="p">;</span>

<span class="nx">subscribe</span><span class="p">(</span><span class="nx">PLAYER</span><span class="p">,</span> <span class="nx">update_player_count</span><span class="p">);</span>
<span class="nx">subscribe</span><span class="p">(</span><span class="nx">PLAYER_DEATH</span><span class="p">,</span> <span class="nx">update_player_count</span><span class="p">);</span>
<span class="nx">subscribe</span><span class="p">(</span><span class="nx">POLL</span><span class="p">,</span> <span class="nx">update_player_count</span><span class="p">);</span>
</code></pre></div>
<p>This creates really simple to follow self contained modules.
Here is the example for bullet state management:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">import</span> <span class="p">{</span><span class="nx">subscribe</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;tiny-pubsub&#34;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">BULLET</span><span class="p">,</span> <span class="nx">POLL</span><span class="p">,</span> <span class="nx">REMOVE_BULLET</span><span class="p">,</span> <span class="nx">TICK</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;../events&#39;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">update_bullet</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;./update_bullet&#39;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">array_to_map_on_key</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;../util/array_to_map_on_key&#39;</span>

<span class="kd">let</span> <span class="nx">bullets</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">subscribe</span><span class="p">(</span><span class="nx">BULLET</span><span class="p">,</span> <span class="nx">bullet</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">bullets</span><span class="p">[</span><span class="nx">bullet</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">bullet</span><span class="p">;</span>
<span class="p">})</span>

<span class="nx">subscribe</span><span class="p">(</span><span class="nx">TICK</span><span class="p">,</span> <span class="p">(</span><span class="nx">current_time</span><span class="p">,</span> <span class="nx">world</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">bullets</span> <span class="o">=</span> <span class="nx">bullets</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">bullet</span> <span class="p">=&gt;</span> <span class="nx">update_bullet</span><span class="p">(</span><span class="nx">bullet</span><span class="p">,</span> <span class="nx">current_time</span><span class="p">,</span> <span class="nx">world</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">bullet</span> <span class="p">=&gt;</span> <span class="nx">bullet</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
<span class="p">})</span>

<span class="nx">subscribe</span><span class="p">(</span><span class="nx">POLL</span><span class="p">,</span> <span class="p">({</span> <span class="nx">bullets</span><span class="o">:</span> <span class="nx">bullets_poll</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">bullets</span> <span class="o">=</span> <span class="nx">array_to_map_on_key</span><span class="p">(</span><span class="nx">bullets_poll</span><span class="p">,</span> <span class="s2">&#34;id&#34;</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">subscribe</span><span class="p">(</span><span class="nx">REMOVE_BULLET</span><span class="p">,</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">delete</span> <span class="nx">bullets</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span>

<span class="kd">function</span> <span class="nx">get_bullets</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">bullets</span><span class="p">).</span><span class="nx">map</span><span class="p">((</span><span class="nx">uuid</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">bullets</span><span class="p">[</span><span class="nx">uuid</span><span class="p">])</span>
<span class="p">}</span>

<span class="k">export</span> <span class="p">{</span><span class="nx">get_bullets</span><span class="p">}</span>
</code></pre></div>
<p>Everything remains self contained.
Overall the frontend code for bulletz.io is significantly simpler and easier to follow.
Several UI bugs were fixed during the refactor due to the UI update logic becoming easier to follow.</p>

<h1 id="event-driven-programming-leads-to-decoupled-code">Event Driven Programming Leads to Decoupled Code</h1>

<p>Rewriting <a href="https://bulletz.io">bulletz.io</a> to use an event driven model resulted in strongly decoupled logic.
The UI updates as well as state updates are written as responses to data emitted elsewhere.
I&rsquo;d recommend giving it a shot if you are writing a web page any time soon without a framework!</p>

<p>The library I wrote for the problem is called tiny-pubsub and the github link can be found <a href="https://github.com/LukeWood/tiny-pubsub">here</a>.</p>

<p>Thanks for reading my first blog post!</p>
]]></content>
		</item>
		
	</channel>
</rss>
